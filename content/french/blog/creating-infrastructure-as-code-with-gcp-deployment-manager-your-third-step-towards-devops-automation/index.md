---
title: "Créer une infrastructure en tant que code dans GCP avec Deployment Manager : la troisième étape vers l’automatisation DevOps"
date: "2018-08-01"
author: "Stacy Véronneau"
resources:
- name: "thumbnail"
  src: "GCP-Thumbnail.png"
- name: "cover"
  src: "GCP-Cover.png"
class_name: "blog post"
slug: /creation-dune-iac-la-troisieme-etape-vers-lautomatisation-devops
aliases:
    - /fr/2018/08/creation-dune-iac-la-troisieme-etape-vers-lautomatisation-devops/
    - /fr/creation-dune-iac-la-troisieme-etape-vers-lautomatisation-devops
---

<div class="post-content"><p><span style="font-weight: 400;">Cette semaine en Californie, j’ai libéré le geek en moi au </span><a href="https://cloud.withgoogle.com/next18/sf/"><span style="font-weight: 400;">Google Next&nbsp;18</span></a><span style="font-weight: 400;">, je me suis emparé d’un Chromebook de la part de l’équipe Grab-and-Go (formidable initiative) et j’ai décidé de terminer la trilogie sur l’Infrastructure en tant que Code (IaC).</span></p><p><span style="font-weight: 400;">Les deux articles précédents étaient axés sur l’Infrastructure en tant que code, où Terraform était perçu comme un couteau suisse aux capacités multinuages. Mais que faire si l’on veut tirer profit d’un service de déploiement d’infrastructure infonuagique précis ?</span></p><p><span style="font-weight: 400;">La Plateforme Infonuagique Google Google Cloud Platform (GCP) possède un tel outil appelé gestionnaire de déploiement (Deployment Manager). Le gestionnaire de déploiement s’exécute sur les bases de fichiers de configuration (YAML) et de modèles (JINJA2 ou PYTHON), vous permettant de définir vos ressources. Ce gestionnaire de déploiement est un outil qui ne se trouve que sur la plateforme GCP, cela vous permet d’accéder aux fonctionnalités tant Beta qu’alpha.</span></p><p><span style="font-weight: 400;">Pour le présent article, comme pour le premier, je vais présenter un petit modèle de gestionnaire de déploiement ; aussi, je vais réviser la version de gestionnaire de déploiement du modèle Terraform plus grand contenu dans mon deuxième article. Tout ceci est conçu pour fonctionner dans la région&nbsp;NorthAmerica-NorthEast-1.</span></p><h3><b>Condition préalable&nbsp;: </b></h3><p><span style="font-weight: 400;">AUCUNE !!!! &nbsp;</span><span style="font-weight: 400;">Simplement, utilisez GCP Cloud Shell sur la plateforme Google pour exécuter tous ces exemples dans le nuage Google Cloud.</span></p><p><img src="/images/blog/post/GCP3.1.png" alt="GCP" width="100%"></p><h1><span style="font-weight: 400;">Simple, mais efficace</span></h1><p><span style="font-weight: 400;">Créer une seule instance dans la région&nbsp;NorthAmerica-NorthEast1-a basée sur la dernière image&nbsp;Ubuntu-1804-LTS, une adresse IP externe.</span></p><pre>resources:
- name: my-first-vm
  type: compute.v1.instance
  properties:
    zone: northamerica-northeast1-a
    machineType: https://www.googleapis.com/compute/v1/projects/your_project_name/zones/northamerica-northeast1-a/machineTypes/f1-micro
    disks:
    - deviceName: boot
      type: PERSISTENT
      boot: true
      autoDelete: true
      initializeParams:
        sourceImage: https://www.googleapis.com/compute/v1/projects/ubuntu-os-cloud/global/images/family/ubuntu-1804-lts
    networkInterfaces:
    - network: https://www.googleapis.com/compute/v1/projects/your_project_name/global/networks/default
      accessConfigs:
      - name: External NAT
        type: ONE_TO_ONE_NAT
</pre><p><span style="font-weight: 400;">Une fois votre modèle crée, vous n’avez qu’à l’exécuter de l’endroit où vous avez installé le</span><a href="https://cloud.google.com/sdk/install"> <span style="font-weight: 400;">Google Cloud SDK</span></a> <span style="font-weight: 400;">ou alors, de mon endroit préféré, la plateforme GCP Cloud Shell.</span></p><pre>gcloud deployment-manager deployments create my-first-dm --config my_first_vm.yaml</pre><p><span style="font-weight: 400;">Vous pouvez visualiser votre déploiement dans la console GCloud Console sous Deployment Manager et l’instance, sous Compute Engine/VM instances. Vous pouvez aussi voir les détails de votre nouveau déploiement avec&nbsp;:</span></p><pre>gcloud deployment-manager deployments describe my-first-dm</pre><p><span style="font-weight: 400;">C’est un exemple simple qui peut vous sembler familier si vous utilisez Terraform. Maintenant, nettoyons le tout et voyons plus grand.</span></p><pre>gcloud deployment-manager deployments delete my-first-dm</pre><h1><span style="font-weight: 400;">Allons-y à fond ou restons à la maison</span></h1><h3><span style="font-weight: 400;">Prenons mon</span> <a href="https://www.cloudops.com/fr/2018/03/creer-une-infrastructure-en-tant-que-code-dans-gcp-avec-packer-et-terraform-la-deuxieme-etape-vers-lautomatisation-devops/"><span style="font-weight: 400;">deuxième article</span></a><span style="font-weight: 400;"> comme base, nous allons recréer le même concept, mais dans le gestionnaire de déploiement (sauf pour l’image figée avec Packer).</span></h3><h2><span style="font-weight: 400;">Figeons notre image dorée</span></h2><ol><li style="font-weight: 400;"><span style="font-weight: 400;">Saisissez l’information de votre « service account » en suivant les étapes présentées dans</span><a href="https://www.cloudops.com/fr/2018/02/comment-deployer-consul-dans-gcp-en-utilisant-terraform-les-premieres-etapes-vers-lautomatisation-devops/"> <span style="font-weight: 400;">mon premier article</span></a> <span style="font-weight: 400;">(Étapes&nbsp;2 et 3)</span><ol><li style="font-weight: 400;"><i><span style="font-weight: 400;">Assurez-vous d’avoir les rôles suivants&nbsp;: (Compute Admin, Service Account User, Storage Admin).</span></i></li></ol></li><li style="font-weight: 400;"><span style="font-weight: 400;">Saisissez le code de mon dépôt</span><a href="https://github.com/sveronneau/gcp-dm"> <span style="font-weight: 400;">https&nbsp;://github.com/sveronneau/gcp-dm</span></a></li><li style="font-weight: 400;"><span style="font-weight: 400;">Saisissez l’information de votre comte GCP pour mettre à jour le fichier </span><i><span style="font-weight: 400;">apache.json</span></i><span style="font-weight: 400;">.</span></li><li style="font-weight: 400;"><span style="font-weight: 400;">Installez </span><a href="https://www.packer.io/"><span style="font-weight: 400;">Packer</span></a></li><li style="font-weight: 400;"><span style="font-weight: 400;">Figez</span></li></ol><pre>packer validate gcp-dm/apache.jon
packer build gcp-dm/apache.json
</pre><h2><span style="font-weight: 400;">Créons notre infrastructure immuable</span></h2><h3><b>Étape&nbsp;1&nbsp;: Créer notre modèle d’instance, notre groupe d’instances géré et notre politique de mise à l’échelle automatique.</b></h3><p><span style="font-weight: 400;">Nous créons un modèle d’instance appelé « apache-template » avec une étiquette appelée « webserver », ce modèle est lié à une micro machine de type&nbsp;f1 utilisant l’image d’Apache family que nous avons figée avec Packer. Nous avons aussi injecté des métadonnées pour un script de démarrage ; cela préparera une page Web d’Apache vers votre serveur. Vous trouverez mon dépôt</span> <span style="font-weight: 400;">GitHub </span><a href="https://github.com/sveronneau/gcp-dm/blob/master/instance-template-mig.yaml"><span style="font-weight: 400;">ici</span></a><span style="font-weight: 400;">.</span></p><p><b>IMPORTANT&nbsp;:</b><span style="font-weight: 400;"> Assurez-vous de changer la valeur de </span><i><span style="font-weight: 400;">you_project</span></i><span style="font-weight: 400;"> pour </span><i><span style="font-weight: 400;">SourceImage</span></i><span style="font-weight: 400;"> et </span><i><span style="font-weight: 400;">network</span></i><span style="font-weight: 400;"> pour qu’il reflète votre ID de projet avant d’exécuter celui-ci.</span><br> <a href="https://github.com/sveronneau/gcp-dm/blob/master/instance-template-mig.yaml"><span style="font-weight: 400;">https://github.com/sveronneau/gcp-dm/blob/master/instance-template-mig.yaml</span></a></p><pre>gcloud deployment-manager deployments create apache --config instance-template-mig.yaml
</pre><h3><b>Étape&nbsp;2&nbsp;: Créer une règle pare-feu et un bilan de santé</b></h3><p><span style="font-weight: 400;">Créer des règles pare-feu soutenant HTTP, HTTPS, SSH et Ping, seulement pour les instances ayant l’étiquette « webserver » ; créer un bilan de santé pour l’équilibreur de charge qui suit.</span></p><p><a href="https://github.com/sveronneau/gcp-dm/blob/master/firewall-rules.yaml" target="_blank">https://github.com/sveronneau/gcp-dm/blob/master/firewall-rules.yaml</a></p><p><a href="https://github.com/sveronneau/gcp-dm/blob/master/hc.yaml" target="_blank">https://github.com/sveronneau/gcp-dm/blob/master/hc.yaml</a></p><pre>gcloud deployment-manager deployments create firewall --config firewall-rules.yaml
gcloud deployment-manager deployments create healthcheck --config hc.yaml
</pre><h3><b>Étape&nbsp;3&nbsp;: Créer l’équilibreur de charge</b></h3><p><span style="font-weight: 400;">La dernière étape est de créer les éléments nécessaires afin d’exposer notre groupe d’instances à l’Internet par une adresse IP publique liée à un équilibreur de charge et des règles de transmission.</span></p><ol><li style="font-weight: 400;"><span style="font-weight: 400;">Service dorsal </span><ol><li style="font-weight: 400;"><span style="font-weight: 400;">Carte montrant l’emplacement de mon groupe d’instances géré pour le trafic HTTP sur le port&nbsp;80.</span></li></ol></li><li style="font-weight: 400;"><span style="font-weight: 400;">Mandataire et carte de l’URL </span><ol><li style="font-weight: 400;"><span style="font-weight: 400;">Régler à la valeur par défaut, rien de compliqué, afin que tout le trafic de l’URL/se rende au service dorsal que nous venons de créer.</span></li><li style="font-weight: 400;"><span style="font-weight: 400;">Acheminer un nouveau mandataire vers cette carte URL.</span></li></ol></li><li style="font-weight: 400;"><span style="font-weight: 400;">Adresse IP publique</span><ol><li style="font-weight: 400;"><span style="font-weight: 400;">Réservons une adresse IP publique pour notre équilibreur de charge</span></li></ol></li><li style="font-weight: 400;"><span style="font-weight: 400;">Règles de transmission</span><ol><li style="font-weight: 400;"><span style="font-weight: 400;">Définir une règle générale qui acheminera tout le trafic vers le port&nbsp;80.</span></li></ol></li></ol><p><a href="https://github.com/sveronneau/gcp-dm/blob/master/LoadBalancer.yaml" target="_blank">https://github.com/sveronneau/gcp-dm/blob/master/LoadBalancer.yaml</a></p><pre>gcloud deployment-manager deployments create load-balancer --config LoadBalancer.yaml</pre><p><b>Étape&nbsp;4&nbsp;: Régler le </b><b><i>Named Port</i></b><b> dans le groupe d’instance géré, mais avec une commande GCLOUD</b></p><p>&nbsp;</p><p><img src="/images/blog/post/GCP3.2.png" alt="GCP" width="100%"></p><p><span style="font-weight: 400;">*= </span><span style="font-weight: 400;">Afin de permettre à ce groupe d’instances de recevoir le trafic provenant de l’équilibreur de charge</span> <span style="font-weight: 400;">apache-url-map, tracez le nom de port http vers un numéro de port.</span></p><p><span style="font-weight: 400;">Vous allez peut-être recevoir un avertissement, dans votre groupe d’instances géré, concernant le nom et le numéro du port. Afin de régler le problème, simplement exécutez la commande suivante dans votre Cloud Shell&nbsp;:</span></p><pre>gcloud compute instance-groups set-named-ports apache-mig --named-ports http:80 --zone northamerica-northeast1-a</pre><h3><b>Étape&nbsp;5&nbsp;: Visualiser les déploiements</b></h3><p><span style="font-weight: 400;">Une fois que tous les déploiements sont effectués, vous pouvez voir les instances, le groupe d’instances géré, les adresses IP publiques, les services dorsaux et frontaux, l’équilibreur de charge et les déploiements, le tout sur la console GCP.</span></p><p><span style="font-weight: 400;">Voici ce à quoi ressemble le gestionnaire de déploiement de la console GCP, une fois que nous avons terminé&nbsp;:</span></p><p><img src="/images/blog/post/GCP3.3.png" alt="GCP" width="100%"></p><p><span style="font-weight: 400;">Si vous cliquez sur l’un des déploiements, comme l’équilibreur de charge, vous verrez tous ses détails et configurations. </span></p><p><img src="/images/blog/post/GCP3.4.png" alt="GCP" width="100%"></p><h3><b>Étape&nbsp;6&nbsp;: Essayons-le</b></h3><p><span style="font-weight: 400;">Maintenant que tout est déployé, procurez-vous une adresse IP publique sous&nbsp;: Network services / Load Balancing. Lorsque vous êtes dans cette section de la console GCP, cliquez sur </span><i><span style="font-weight: 400;">apache-url-map</span></i><span style="font-weight: 400;"> et sur FRONTEND à côté de HTTP. Vous verrez l’adresse IP publique que nous avons demandée auparavant.</span></p><p>&nbsp;</p><p><span style="font-weight: 400;">Pointez votre navigateur sur</span> <a href="http://public_ip/"><span style="font-weight: 400;">http://public_ip</span></a> <span style="font-weight: 400;">et vous devriez voir un petit site Internet vous indiquant vers quel serveur de votre groupe d’instances géré se dirige votre requête. </span><i><span style="font-weight: 400;">Cela peut prendre quelques minutes puisque nous devons nous assurer que l’équilibreur de charge est approvisionné et fonctionne adéquatement dans la plateforme GCP.</span></i></p><p><span style="font-weight: 400;">Lorsque le site répond, allez-y et actualisez comme bon vous semble ; vous verrez votre requête en plein équilibrage de charge entre les nœuds.</span></p><h1><span style="font-weight: 400;">C’est terminé !</span></h1><p><span style="font-weight: 400;">Voilà, vous avez maintenant un déploiement de notre site Internet complètement prédéfini, avec capacités de mise à l’échelle et d’équilibrage de charge automatiques (saturez votre groupe d’instances géré et regardez-le croître) et tout cela, crée avec le gestionnaire de déploiement.</span></p><p><span style="font-weight: 400;">N’oubliez pas de tout nettoyer !</span></p><h1><span style="font-weight: 400;">Maintenant, allez de l’avant et automatisez tous les objets !</span></h1><p><span style="font-weight: 400;">Grâce à ces trois articles de blogue, vous voyez les fondements de ce que peut être une infrastructure immuable. Vous faciliterez grandement votre vie en mettant en œuvre ces principes et méthodologies dans la gestion du cycle de vie de votre application. J’espère que vous avez trouvé utiles ces articles sur la mise en œuvre de l’infrastructure en tant que code et qu’ils vous aideront à atteindre le nirvana DevOps.</span><br> <span style="font-weight: 400;">CloudOps offre des solutions DevOps et détient un large éventail d’expertises. Jetez un coup d’œil à nos ateliers pratiques sur</span><a href="https://www.cloudops.com/fr/infrastructure-en-tant-que-code/"> <span style="font-weight: 400;">l’Infrastructure en tant que Code</span></a><span style="font-weight: 400;">, et </span><a href="https://www.cloudops.com/fr/a-propos/nous-joindre/"><span style="font-weight: 400;">contactez-nous</span></a> <span style="font-weight: 400;">pour en apprendre plus sur notre expertise et sur ce que nous pouvons faire pour votre organisation.</span></p><h3><a href="https://www.cloudops.com/fr/2018/02/comment-deployer-consul-dans-gcp-en-utilisant-terraform-les-premieres-etapes-vers-lautomatisation-devops/" target="_blank"><img class="size-full wp-image-749 alignright" title="Part 1" src="/images/blog/post/Meme1.jpg" alt="Automate Things" width="250" height="150"></a><br> <a href="https://www.cloudops.com/fr/2018/02/comment-deployer-consul-dans-gcp-en-utilisant-terraform-les-premieres-etapes-vers-lautomatisation-devops/" target="_blank">Créer une infrastructure en tant que code dans GCP avec Consul et Terraform :&nbsp;Les premières étapes vers l’automatisation DevOps</a></h3><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><h3><a href="Créer une infrastructure en tant que code dans GCP avec Packer et Terraform : les deuxième étapes vers l’automatisation DevOps" target="_blank"><img class="size-full wp-image-749 alignright" title="Part 2" src="/images/blog/post/Meme2.jpg" alt="Automate Things" width="250" height="150"></a><br> <a href="https://www.cloudops.com/fr/2018/03/creer-une-infrastructure-en-tant-que-code-dans-gcp-avec-packer-et-terraform-la-deuxieme-etape-vers-lautomatisation-devops/" target="_blank">Créer une infrastructure en tant que code dans GCP avec Packer et Terraform : la deuxième étape vers l’automatisation DevOps</a></h3><p>&nbsp;</p><h3><img class="size-full wp-image-749 alignleft" title="Stacy Véronneau" src="/images/blog/post/unnamed.jpg" alt="" width="130" height="150">Stacy Véronneau</h3><p>Stacy Véronneau est un éminent architecte de solutions chez CloudOps, il travaille de près avec la plateforme infonuagique de Google : Google Cloud Platform (GCP). Il collabore actuellement avec Google afin d’aider les clients à migrer vers GCP et tirer pleinement avantage de sa force. De plus, il est ambassadeur officiel OpenStack, il a donné des conférences lors de Sommets OpenStack et a organisé des meetups à travers le Canada.</p><p>&nbsp;</p><p><small>Photo credits: Emma De Angelis et memegenerator.net</small></p>
