---
title: "Créer une infrastructure en tant que code dans GCP avec Consul et Terraform : Les premières étapes vers l’automatisation DevOps"
lastmod: "2018-02-28"
author: "Stacy Véronneau"
resources:
- name: "thumbnail"
  src: "GCP.jpg"
class_name: "blog post"
slug: /comment-deployer-consul-dans-gcp-en-utilisant-terraform-les-premieres-etapes-vers-lautomatisation-devops
aliases:
    - /fr/2018/02/comment-deployer-consul-dans-gcp-en-utilisant-terraform-les-premieres-etapes-vers-lautomatisation-devops/
    - /fr/comment-deployer-consul-dans-gcp-en-utilisant-terraform-les-premieres-etapes-vers-lautomatisation-devops
---

<p>L’infrastructure en tant que code (IaC) a attiré beaucoup d’attention ces derniers temps. Elle prend le code pour gérer la configuration et l’automatisation de l’infrastructure de votre application afin de libérer des ressources et ainsi réduire les risques, les dettes techniques et les erreurs. L’IaC prend de plus en plus d’importance dans la réussite des pratiques DevOps. Terraform, par Hashicorp est un outil d’infrastructure multi-plate-forme qui vous permet d’automatiser votre infrastructure en utilisant les mêmes outils sur plusieurs plateformes. L’outil Ansible peut être utilisé pour bâtir et gérer les configurations d’applications à distances et les installations de MV conçues sur votre déploiement d’infrastructure Terraform.</p><p>Étant moi-même accro à Terraform, je suis vraiment emballé par le fait qu’il puisse faire progresser les pratiques DevOps et IaC. Je publie cet article dans le but d’expliquer comment utiliser Terraform pour déployer une instance dans GCP tout en utilisant Ansible pour provisionner Consul de HashiCorp. L’idée m’est venue au meetup des utilisateurs Hashicorp (HashiCorp User Group : HUG) qui fut organisé par CloudOps, partenaire de HashiCorp, à Montréal le 16 janvier dernier. Après avoir discuté avec une personne qui désirait faire une démonstration de faisabilité dans GCP, j’ai réalisé à quel point il serait approprié d’utiliser Terraform ou Packer avec Ansible sur GCP.</p><p>Terraform a la qualité d’être idempotent, cela signifie que l’on obtient toujours les mêmes résultats, chaque fois que l’on exécute le script, permettant ainsi de bâtir une infrastructure complètement immuable pour soutenir les configurations. Les étapes suivantes démontrent comment obtenir un processus complètement automatisé pour lancer des instances dans GCP. Ce processus implique le lancement d’une instance sur GCP, via Terraform, déclenchant alors un playbook Ansible qui installe pour vous, dans l’instance, la version 1.0.6 de Consul. Lorsque vous entrez à nouveau dans votre instance, le processus s’y trouve déjà et vous vous trouvez devant une page blanche à configurer comme bon vous semble.</p><p><strong>Étape 1</strong> – Assurez-vous d’avoir un projet GCP et une clé SSH à l’échelle de tout le projet, car vous en aurez besoin pour accéder à votre instance. Les instructions à cet effet se trouvent <a href="https://cloud.google.com/compute/docs/instances/adding-removing-ssh-keys" target="_blank">ici</a>, vous devriez être dirigés vers une page qui ressemble à ceci:</p><p><img style="width:100%;" src="/images/blog/post/step1.jpg
" alt="Comment déployer Consul dans GCP en utilisant Terraform"></p><p><strong>Étape 2</strong> – Allez à IAM &amp; admin sur la console GCP pour commencer à créer un <a href="https://cloud.google.com/compute/docs/access/service-accounts" target="_blank">Compte de service</a> dans votre projet GCP.</p><p><img style="width:100%;" src="/images/blog/post/step2.png
" alt="Comment déployer Consul dans GCP en utilisant Terraform"></p><p><strong>Étape 3</strong> – Créez un compte de service. Assurez-vous que les rôles Compute Instance Admin (v1) et Service Account User sont sélectionnés. La case « Furnish a new private key » doit être cochée et assurez-vous de sélectionner JSON comme type de clé (« Key type »). Puis cliquez sur Create.<br> Votre compte de service sera alors créé et un fichier JSON sera téléchargé localement sur votre machine. Vous devez garder ce fichier.</p><p><img style="width:100%;" src="/images/blog/post/Untitled.jpg" alt="Comment déployer Consul dans GCP en utilisant Terraform"></p><p><img style="width:100%;" src="/images/blog/post/Untitled-1.jpg" alt="Comment déployer Consul dans GCP en utilisant Terraform"></p><p><strong>Étape 4</strong> – Téléchargez et installez <a href="https://www.terraform.io/downloads.html" target="_blank">Terraform</a> et <a href="http://docs.ansible.com/ansible/latest/intro_installation.html " target="_blank">Ansible</a>.</p><p><strong>Étape 5</strong> – Clonez <a href="https://github.com/sveronneau/gcp" target="_blank">mon GitHub repo</a> ou téléchargez-le comme fichier Zip.</p><p><strong>Étape 6</strong> – Adaptez le code de mon dépôt (ci-dessus) selon votre environnement en changeant les valeurs suivantes qui proviennent du fichier gcp/consul/consul.tf :</p><p>Dans provider « Google », changez les identifiants pour  “${file(“/path_to/gcp_service_account.json“)}” et le projet pour “your_gcp_project“.</p><p>Dans resource ‘google_compute_instance’ ‘ansible’, changez le projet pour ‘your_gcp_project’ et exécuter la commande ‘sleep 90; ANSIBLE_HOST_KEY_CHECKING=False ansible-playbook -u your_ssh_key_username (de l’étape 1) –private-key /path_to/my_private_key -i ‘${google_compute_instance.ansible.network_interface.0.access_config.0.assigned_nat_ip}’, master.yml’.</p><p><strong>Étape 7 </strong> – De la ligne de commande, activez le fournisseur GCP en exécutant ‘terraform init gcp/consul’.</p><p><strong>Étape 8</strong> – Exécutez le script !!</p><p><strong>terraform plan gcp/consul</strong> et <strong>terraform apply gcp/consul</strong></p><p>Soyez patient, cela peut prendre jusqu’à deux minutes. Une fois que tout est installé, retournez aux instances Compute Engine/VM où vous trouverez votre instance Consul. À partir de là, cliquez sur le bouton ‘Connect SSH’ pour ouvrir une session de votre instance.</p><p><img style="width:100%;" src="/images/blog/post/Untitled-2.jpg" alt="Comment déployer Consul dans GCP en utilisant Terraform"></p><p>Voici ce que vous verrez lorsque vous serez dans votre instance. Cela démontre que le processus fonctionne et que Consul est exploité en arrière-plan.</p><p><img style="width:100%;" src="/images/blog/post/Untitled-3.jpg" alt="Comment déployer Consul dans GCP en utilisant Terraform"></p><p><i>Félicitations !!! Vous avez déployé Consul en utilisant Terraform et Ansible sur GCP.</i></p><p>N’oubliez pas de nettoyer le déploiement en exécutant : terraform destroy gcp/consul avant d’ouvrir Terraform à nouveau. J’ai vu de nombreuses personnes provoquer la colère des dieux pour avoir oublié de le faire.</p><p>Le script que vous trouvez ici est un exemple simple d’un déploiement de Consul dans GCP. Vous pouvez aussi utiliser ce processus pour automatiser le déploiement de n’importe quel autre outil, tel que Apache Web Server, ou encore Jenkins, si vous désirez rester dans le pipeline CI/CD. Terraform est vraiment un outil formidable pour automatiser votre infrastructure. Sa nature multi-plate-forme et son intégration aisée avec Ansible signifient que l’automatisation dans le but d’intégrer L’IaC dans une entreprise DevOps ne peut que devenir plus facile.</p><p><strong>Passez au niveau supérieur</strong> – Essayez d’utiliser Packer de HashiCorp pour figer Consul dans des images GCP, ainsi, vous n’aurez pas à le faire chaque fois. Vous pouvez ensuite, avec Terraform et sans Ansible, créer une instance basée sur l’image figée. Comme étape finale vers un déploiement de production, à partir de votre image figée, vous pouvez créer un modèle d’instance et un groupe d’instances gérées pour surveiller votre nouvelle grappe Consul et l’attacher à un équilibreur de charge GCP.</p><p><strong>Visitez ces sites Web et ces dépôts pour vous partir du bon pied :</strong></p><p><a href="http://docs.ansible.com/ansible/latest/guide_gce.html
" target="_blank">http://docs.ansible.com/ansible/latest/guide_gce.html<br> </a></p><p><a href="https://github.com/sveronneau/gcp" target="_blank">https://github.com/sveronneau/gcp</a></p><p><a href="https://www.terraform.io/docs/providers/google/" target="_blank">https://www.terraform.io/docs/providers/google/</a></p><p><a href="https://github.com/GoogleCloudPlatform?utf8=✓&amp;q=terraform" target="_blank">https://github.com/GoogleCloudPlatform?utf8=✓&amp;q=terraform</a></p><p>Si vous désirez vous impliquer dans la communauté HashiCorp, jetez un coup d’œil aux meetups HUG organisés à <a href="https://www.meetup.com/Montreal-HashiCorp-User-Group/" target="_blank">Montréal</a>, <a href="https://www.meetup.com/Toronto-HashiCorp-User-Group/" target="_blank">Toronto</a>, et à <a href="https://www.meetup.com/Quebec-City-HashiCorp-User-Group/" target="_blank">Québec</a>.</p><p><strong>Maintenant, allez de l’avant et automatisez toutes choses !</strong></p><p>En tant que partenaire de Google et de HashiCorp, CloudOps offre des solutions DevOps. <a href="https://www.cloudops.com/fr/a-propos/nous-joindre/" _blank"="">Contactez-nous</a> pour en apprendre plus sur notre expertise et sur ce que nous pouvons apporter à votre organisation.</p><h3><a href="Créer une infrastructure en tant que code dans GCP avec Packer et Terraform : la deuxième étape vers l’automatisation DevOps" target="_blank"><img class="size-full wp-image-749 alignright" title="Part 2"  style="width: 250px;" src="/images/blog/post/Meme2.jpg" alt="Automate Things" width="250" height="150"></a><br> <a href="https://www.cloudops.com/fr/2018/03/creer-une-infrastructure-en-tant-que-code-dans-gcp-avec-packer-et-terraform-la-deuxieme-etape-vers-lautomatisation-devops/" target="_blank">Créer une infrastructure en tant que code dans GCP avec Packer et Terraform : les deuxième étapes vers l’automatisation DevOps</a></h3><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><h3><a href="https://www.cloudops.com/fr/2018/08/creation-dune-iac-la-troisieme-etape-vers-lautomatisation-devops/" target="_blank"><img class="size-full wp-image-749 alignright" title="Part 3" style="width: 250px;" src="/images/blog/post/Meme3.jpg" alt="Automate Things" width="250" height="150"></a><br> <a href="https://www.cloudops.com/fr/2018/08/creation-dune-iac-la-troisieme-etape-vers-lautomatisation-devops/" target="_blank">Créer une infrastructure en tant que code dans GCP avec Deployment Manager : les troisième étapes vers l’automatisation DevOps</a></h3><p>&nbsp;<br> &nbsp;</p><h3><img class="size-full wp-image-749 alignleft" title="Stacy Véronneau" style="width: 150px;" src="/images/blog/post/YfQt7-58_400x400.jpg" alt="Stacy Véronneau" width="150" height="150">À propos de l’auteur – Stacy Véronneau</h3><p>Stacy Véronneau est un éminent architecte de solutions chez CloudOps, il travaille de près avec la plateforme infonuagique de Google : Google Cloud Platform (GCP). Il collabore actuellement avec Google afin d’aider les clients à migrer vers GCP et tirer pleinement avantage de sa force. De plus, il est ambassadeur officiel OpenStack, il a donné des conférences lors de Sommets OpenStack et a organisé des meetups à travers le Canada.</p>
