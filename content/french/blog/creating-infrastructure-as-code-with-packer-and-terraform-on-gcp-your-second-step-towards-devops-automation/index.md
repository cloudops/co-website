---
title: "Créer une infrastructure en tant que code dans GCP avec Packer et Terraform : la deuxième étape vers l’automatisation DevOps"
date: "2018-03-30"
author: "Stacy Véronneau"
resources:
- name: "thumbnail"
  src: "GCP.jpg"
class_name: "blog post"
slug: /creer-une-infrastructure-en-tant-que-code-dans-gcp-avec-packer-et-terraform-la-deuxieme-etape-vers-lautomatisation-devops
aliases:
    - /fr/2018/03/creer-une-infrastructure-en-tant-que-code-dans-gcp-avec-packer-et-terraform-la-deuxieme-etape-vers-lautomatisation-devops/
    - /fr/creer-une-infrastructure-en-tant-que-code-dans-gcp-avec-packer-et-terraform-la-deuxieme-etape-vers-lautomatisation-devops
---

<p>Tout le monde veut adopter une infrastructure en tant que code pour configurer et automatiser leur infrastructure applicative tandis qu’elle s’adapte aux pratiques exemplaires du DevOps. De trouver des façons d’automatiser votre pipeline CI/CD est au cœur de cette transition et est d’un très grand intérêt pour moi.</p><p><strong>Ce que nous avons fait la dernière fois</strong></p><p>Le dernier <a href="https://www.cloudops.com/fr/2018/02/comment-deployer-consul-dans-gcp-en-utilisant-terraform-les-premieres-etapes-vers-lautomatisation-devops/" target="_blank">article</a> vous expliquait comment créer une MV pour entièrement automatiser le processus de lancement d’instances dans GCP. Il démontrait comment utiliser Ansible et Terraform par Hashicorp pour installer dans votre instance une version « vanille » de Consul, outil Hashicorp qui découvre et configure des services dans votre infrastructure. Vous vous trouviez devant une toile blanche à configurer comme bon vous semble.</p><p><strong>Ce que nous ferons cette fois-ci</strong></p><p>Cette fois-ci, nous illustrerons ce procédé dans un cas d’utilisation réelle et le mettrons en production. Le dernier article vous donnait le contexte pour automatiser les instances dans GCP, cet article-ci démontrera comment automatiser le déploiement d’instances multiples. Cela sera effectué par un groupe d’instances géré qui peut mettre à l’échelle et rétablir votre environnement automatiquement. Cela vous permettra ensuite d’exploiter ces déploiements dans le nuage et surtout, de tirer profit des capacités de mise à l’échelle et de rétablissement automatique de GCP, comme fournisseur infonuagique.</p><p>Déployer ces instances dans le nuage vous permet de mettre votre application à l’échelle selon la demande et d’avoir un déploiement sur des zones et des régions multiples. Par exemple, vous pourriez déployer vos serveurs dans les régions « northamerica-northeast1 » et « us-central1 » ou encore, dans une seule région, mais sur toutes les zones disponibles. Cela aura pour effet de distribuer votre infrastructure et vous aurez toujours un déploiement à votre disposition si l’un de vos serveurs tombe en panne. Vous devez déployer au moins trois instances et pouvez en utiliser jusqu’à cinq pour la mise à l’échelle automatique. En ayant le déploiement de vos instances automatisé par un groupe d’instances géré, vous tirerez pleinement profit du pouvoir de la plateforme Google Cloud.</p><p><strong>Comment nous y prendrons-nous</strong></p><p>Cette fois-ci, au lieu de Consul, nous nous concentrerons sur la façon de maximiser Apache Web Server. Nous utiliserons à nouveau Terraform, mais surtout, nous préparerons Apache dans une image Ubuntu prise sur Google. Par « préparer », je veux dire de mettre une image standard à votre main pour créer un modèle. Ce modèle vous fera épargner du temps lorsque vous lancerez une instance de serveur Apache. L’automatisation vous permettra de sauter certaines étapes préparatoires, comme l’installation d’Apache dans toutes les MV ou instances.</p><p><i>Veuillez prendre note</i> : GCP met très fréquemment ses images à jour (encore plus fréquemment que les images Ubuntu Cloud), il est donc très important d’inclure la préparation d’images dans votre pipeline CI/CD si vous désirez constamment avoir une infrastructure à jour. Vos procédés automatisés devraient toujours exploiter des images nouvellement préparées et votre déploiement doit être sur un système d’exploitation à jour.</p><p><strong>Préparation</strong></p><p><strong>Étape 1</strong> – Saisissez l’information de votre « service account » en suivant les étapes présentées dans mon premier <a href="https://www.cloudops.com/fr/2018/02/comment-deployer-consul-dans-gcp-en-utilisant-terraform-les-premieres-etapes-vers-lautomatisation-devops/" target="_blank">blogue</a> (Étapes 2 et 3)</p><p>Assurez-vous d’avoir les rôles suivants : (Compute Admin, Service Account User, Storage Admin).</p><p><strong>Étape 2</strong> – Saisissez le code de mon GitHub <a href="https://github.com/sveronneau/gcp-mig-lb" target="_blank">repo</a></p><p><strong>Étape 3</strong> – Prenez l’information de votre compte GCP pour mettre à jour les fichiers <i>apache.json</i> et <i>variables.tf</i></p><p><strong>Étape 4</strong> – Installez <a href="https://www.packer.io/" target="_blank">Packer</a> et <a href="https://www.terraform.io/" target="_blank">Terraform</a>&nbsp;dans le dossier gcp-mig-lb.</p><p><strong>Flux de travail</strong></p><p><strong>Étape 1</strong> – Utilisez Packer pour préparer un Ubuntu 16.04 LTS personnalisé avec une image Apache Web Server.</p><pre>packer validate apache.json</pre><pre>packer build apache.json</pre><p><strong>Étape 2</strong> – Lancer le script Terraform qui créera un modèle avec cette image dans GCP.</p><pre>terraform init</pre><pre>terraform plan</pre><pre>terraform apply</pre><p><strong>Étape 3</strong> – De ce modèle, nous pouvons créer un groupe d’instances géré qui déploiera 3 instances identiques basées sur notre image préparée. Aussi, cela injectera des métadonnées qui créeront une page Web statique contenant le nom du serveur et ses adresses IP internes et externes.</p><p><strong>Étape 4</strong> – Créer une règle pare-feu afin de permettre au trafic HTTP d’arriver vers ce groupe. C’est très utile pour atteindre tous nos serveurs.</p><p><strong>Étape 5</strong> – Créer un service frontal et dorsal piloté par un équilibreur de charge et des règles de redirection.</p><p><strong><br> Étape 6</strong> – Reculez et appréciez ce que vous avez accompli.</p><pre>Attendez quelques minutes puis ouvrez un navigateur avec l'adresse IP de votre équilibreur de charge GCP.
L'adresse IP de l'équilibreur de charge GCP peut être trouvée dans : Network Services / Load balancing
Cliquez sur HTTP-lb-url-map et regardez dans la section frontale, protocol HTTP. C'est là que vous verrez votre adresse IP publique.</pre><p>Ouvrez votre navigateur <a href="http://frontend_public_ip">http://frontend_public_ip</a>. Actualisez la page et vous verrez que vous vous rendez vers vos serveurs Apache aléatoirement.</p><p><strong>Et voilà ! </strong>Vous avez réussi à créer un groupe d’instances géré avec mise à l’échelle et rétablissement automatique piloté par un équilibreur de charge Google Cloud. Bien que tout le déploiement présenté ci-dessus peut être fait de façon manuelle, nous l’avons automatisé avec Terraform. Cela vous permet de le déployer à l’échelle, dans le nuage, et dans de multiples zones ou régions, créant ainsi une infrastructure immuable du début à la fin qui constitue une approche DevOps Infrastructure en tant que Code.</p><p>Et la suite.. Finalement, dans une approche intégrale, nous pourrions tout refaire cela en utilisant, au lieu de Terraform, le Gestionnaire de déploiement de Google Cloud. Bâti par Google, le Gestionnaire de déploiement est leur version de Terraform spécialement conçue pour leur propre plateforme infonuagique. Elle inclut des fonctionnalités bêta et alpha que les clients veulent utiliser, mais qui ne sont pas habituellement disponibles sur Terraform avant d’être disponibles de façon générale.</p><p>Ce sera le sujet de mon prochain article de cette série sur l’automatisation et GCP. Gardez l’œil ouvert !</p><p><strong>Maintenant, allez de l’avant et automatisez tous les objets !</strong></p><p>CloudOps offre des solutions DevOps et détient un large éventail d’expertises. Jetez un coup d’œil à nos ateliers pratiques sur « l’Infrastructure as Code » et contactez-nous pour en apprendre plus sur notre expertise et ce que nous pouvons faire pour votre organisation.</p><h3><a href="https://www.cloudops.com/fr/2018/02/comment-deployer-consul-dans-gcp-en-utilisant-terraform-les-premieres-etapes-vers-lautomatisation-devops/" target="_blank"><img class="size-full wp-image-749 alignright" title="Part 1"  style="width: 250px;" src="/images/blog/post/Meme1.jpg" alt="Automate Things" width="250" height="150"></a><br> <a href="https://www.cloudops.com/fr/2018/02/comment-deployer-consul-dans-gcp-en-utilisant-terraform-les-premieres-etapes-vers-lautomatisation-devops/" target="_blank">Créer une infrastructure en tant que code dans GCP avec Consul et Terraform :&nbsp;Les premières étapes vers l’automatisation DevOps</a></h3><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><h3><a href="https://www.cloudops.com/fr/2018/08/creation-dune-iac-la-troisieme-etape-vers-lautomatisation-devops/" target="_blank"><img class="size-full wp-image-749 alignright" title="Part 3"  style="width: 250px;" src="/images/blog/post/Meme3.jpg" alt="Automate Things" width="250" height="150"></a><br> <a href="https://www.cloudops.com/fr/2018/08/creation-dune-iac-la-troisieme-etape-vers-lautomatisation-devops/" target="_blank">Créer une infrastructure en tant que code dans GCP avec Deployment Manager : les troisième étapes vers l’automatisation DevOps<br> </a></h3><p>&nbsp;<br> &nbsp;</p><h3><img class="size-full wp-image-749 alignleft" title="Stacy Véronneau" style="width: 150px;" src="/images/blog/post/YfQt7-58_400x400.jpg" alt="" width="150" height="150">À propos de l’auteur – Stacy Véronneau</h3><p>Stacy Véronneau est un éminent architecte de solutions chez CloudOps, il travaille de près avec la plateforme infonuagique de Google : Google Cloud Platform (GCP). Il collabore actuellement avec Google afin d’aider les clients à migrer vers GCP et tirer pleinement avantage de sa force. De plus, il est ambassadeur officiel OpenStack, il a donné des conférences lors de Sommets OpenStack et a organisé des meetups à travers le Canada.<br> &nbsp;</p><p><small>Crédit photo : Emma De Angelis et memegenerator.net</small></p>
