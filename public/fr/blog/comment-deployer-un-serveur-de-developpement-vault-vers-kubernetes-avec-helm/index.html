<!DOCTYPE html>
<html><head>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

   
   
   
   
   <link rel="stylesheet" as="style" type="text/css" href="/css/style.min.be530482478bd4bdbb9c54d01cbdf88359a7f0a9618ecb0f3f3478171a3abaf5.css" integrity="sha256-vlMEgkeL1L27nFTQHL34g1mn8KlhjssPPzR4Fxo6uvU=" crossorigin="anonymous" media="screen" />
    
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    
    <link rel="icon no-follow" href="/images/favicon.ico" type="image/x-icon">
    
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,600,600i,700|Open+Sans:400,700&display=swap" rel="stylesheet">
    <script src="https://kit.fontawesome.com/d8b2e2ddb4.js" crossorigin="anonymous"></script>


    
        <title>CloudOps - Comment déployer un serveur de développement Vault vers Kubernetes avec Helm.</title>
    
</head><body>
            
            
<div class="navbar-card" id="main-nav">
  <nav class="navbar navbar-expand-xl">
    
    <a class="navbar-brand mr-auto" href="/">
      <img src="/images/cO-logo-horizontal.png" width="245px" height="auto" alt="CloudOps logo">
    </a>
    <a class="navbar-toggler" data-toggle="collapse" data-target="#navbarSupportedContent"
      aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"><i class="fas fa-hamburger"></i></span>
    </a>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto list-group list-group-flush">

        <li class="nav-item dropdown">
          <a class="nav-link" href="/solutions" id="navbarDropdownMenuLink" role="button" data-toggle="dropdown"
            aria-haspopup="true" aria-expanded="false">Solutions</a>
          <div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
            <div class="row">
              <div class="col-xl-12 nav-main-section">
                <button href="/solutions">Solutions Overview</button>
              </div>
            </div>
            <div class="row">
              <div class="col-xl-3 offset-xl-1 col-lg-3 offset-lg-0 solutions-dropdown-items-group">
                <a href="/using-cloud"><h3 class="dropdown-item list-group-item list-group-item-action">Using Cloud</h3></a>
                <a class="dropdown-item list-group-item list-group-item-action" href="/cloud-native-consulting">Cloud Native Consulting</a>
                <a class="dropdown-item list-group-item list-group-item-action" href="/cloud-migration">Cloud Migration</a>
                <a class="dropdown-item list-group-item list-group-item-action" href="/managed-services-augmented-support">Managed Services <br> Augmented Support</a>



              </div>
              <div class="col-xl-3 offset-xl-0 col-lg-3 offset-lg-1 solutions-dropdown-items-group">
                <a href="/delivering-cloud"><h3 class="dropdown-item list-group-item list-group-item-action">Delivering Cloud</h3></a>
                <a class="dropdown-item list-group-item list-group-item-action" href="/delivering-cloud-consulting">Consulting</a>
                <a class="dropdown-item list-group-item list-group-item-action" href="/managed-services-augmented-support">Managed Services <br> Augmented Support</a>
              </div>

              <div class="col-xl-3 offset-xl-0 col-lg-3 offset-lg-1 solutions-dropdown-items-group">
                <a href=""><h3 class="dropdown-item list-group-item list-group-item-action">Transformations</h3></a>
                <a class="dropdown-item list-group-item list-group-item-action" href="#">DevOps Transformation</a>
                <a class="dropdown-item list-group-item list-group-item-action" href="#">CloudOps Transformation</a>
                <a class="dropdown-item list-group-item list-group-item-action" href="#">NetDevOps Transformation</a>
              </div>
            </div>
            <div class="row">
              <div class="col-xl-3 nav-cta">
                <img src="/images/navbar-arrows.svg">
              </div>
              <div class="col-xl-9 nav-cta horizontal-nav-cta">
                  <a href="https://cdn2.hubspot.net/hubfs/732832/Branded%20Images/EN_CloudOps_OP_Services_.pdf" target="_blank"><h2>Meet business goals more efficiently</h2>
                <p>Tips on how to transform your business by evolving team culture and tooling while adopting cloud native practices.</p><div class="triangle-right">
                    <div class="inner-triangle"></div></a>
              </div>
            </div>
          </div>
        </li>
        <li class="nav-item dropdown">
          <a class="nav-link" href="/training" id="navbarDropdownMenuLink" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Training</a>
          <div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
            <div class="row solutions-dropdown-row">
              <div class="col-xl-4 col-lg-4 training-dropdown-items-group">
                <img src="/images/fish-circle.png" width="70px">
                <a class="dropdown-item list-group-item list-group-item-action" href="/workshops"><h3>Workshops</h3></a>
              </div>
              <div class="col-xl-4 col-lg-4 training-dropdown-items-group">
                <img src="/images/fish-circle.png" width="70px">
                <a class="dropdown-item list-group-item list-group-item-action" href="/experts"><h3>Our Experts</h3></a>
              </div>
              <div class="col-xl-4 col-lg-4 training-dropdown-items-group">
                <img src="/images/fish-circle.png" width="70px">
                <a class="dropdown-item list-group-item list-group-item-action" href="/workshops-calendar"><h3>Calendar</h3></a>
              </div>
            </div>
            <div class="row">
              <div class="col-xl-3 nav-cta">
                <img src="/images/navbar-arrows.svg">
              </div>
              <div class="col-xl-9 nav-cta horizontal-nav-cta">
                <a href="/images/ressources/infographics/kubernetes-distribution-3-1.pdf" target="_blank">
                <h2>Are you a Kubernetes unicorn?</h2>
                <p>Take our quiz to find out</p>
              </a>
              </div>
            </div>
          </div>
        </li>
        <li class="nav-item dropdown reading-dropdown">
          <a class="nav-link" href="/reading" id="navbarDropdownMenuLink" role="button" data-toggle="dropdown"
            data-reference="parent" data-offset="50%,20" aria-haspopup="true" aria-expanded="false">Reading</a>
          <div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
            <div class="row">
              <div class="col-xl-3 nav-cta">
                <img src="/images/navbar-arrows.svg">
                <a href="https://cdn2.hubspot.net/hubfs/732832/Gated%20Content/WP_Securing%20Your%20DevOps%20Platform%20Enterprise_2019.pdf" target="_blank">
                <h2>Secure your DevOps platform</h2>
                <p>White paper highlighting how to handle security challenges faced by enterprises</p>
                </a>
              </div>
              <div class="col-xl-9">
                <div class="row sub-nav-items">
                  <div class="col-xl-12 nav-main-section">
                    <button href="/solutions">Solutions Overview</button>
                  </div>
                </div>
                <div class="row">
                  <div class="col-xl-2 offset-xl-1">
                    <img src="/images/fish-circle.png" width="70px">
                  </div>
                  <div class="col-xl-3">
                    <h3 class="dropdown-item list-group-item list-group-item-action">Blog</h3>
                  </div>
                  <div class="col-xl-2 offset-xl-0">
                    <img src="/images/fish-circle.png" width="70px">
                  </div>
                  <div class="col-xl-3">
                    <a><h3 class="dropdown-item list-group-item list-group-item-action">Ressources</h3></a>
                    <a class="dropdown-item list-group-item list-group-item-action" href="#">White Papers</a>
                    <a class="dropdown-item list-group-item list-group-item-action" href="#">Case Studies</a>
                    <a class="dropdown-item list-group-item list-group-item-action" href="#">Infographics</a>
                    <a class="dropdown-item list-group-item list-group-item-action" href="#">One Pagers</a>
                  </div>
                </div>
              </div>
            </div>
        </li>
        <li class="nav-item dropdown company-dropdown">
          <a class="nav-link" href="/company" id="navbarDropdownMenuLink" role="button" data-toggle="dropdown"
            data-reference="parent" data-offset="50%,20" aria-haspopup="true" aria-expanded="false">Company</a>
          <div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
            <div class="row">
              <div class="col-xl-3 nav-cta">
                <img src="/images/navbar-arrows.svg">
                <a href="/blog/cloudops-manifesto/" target="_blank">
                <h2>The CloudOps Manifetso</h2>
                <p>11 key success factors we have learned from our adventures in the cloud</p>
              </div>
              <div class="col-xl-6 nav-main-section">
                <button href="/why-cloudops">Why choose CloudOps</button>
                <div class="row sub-nav-items">
                  <div class="col-xl-3 offset-xl-0">
                    <img src="/images/fish-circle.png" width="70px">
                  </div>
                  <div class="col-xl-6">
                    <a class="dropdown-item list-group-item list-group-item-action" href="/about-us">About Us</a>
                    <a class="dropdown-item list-group-item list-group-item-action" href="/partners">Our Partners</a>
                    <a class="dropdown-item list-group-item list-group-item-action" href="">Careers</a>
                    <a class="dropdown-item list-group-item list-group-item-action" href="">Events Calendar</a>
                  </div>
                </div>
              </div>
              <div class="col-xl-3 nav-cta">
                <img src="/images/navbar-arrows.svg">
                <a href="blog/staff-augmentation-vs-project-based-services-for-devops-and-cloud-projects/">
                <h2>Accelerate your software release cycles</h2>
                <p>Comparing staff augmentation to project-based services for DevOps and cloud projects</p>
                </a>
              </div>
            </div>
          </div>
        </li>
        <li class="nav-item">
          <button class="btn" type="submit">Contact</button>
        </li>
        <li>
          
        </li>
      </ul>
    </div>
  </nav>
</div><div class="container-fluid main-content">

<main class="post">
    <div class="row">
        <div class="col-xl-8 offset-xl-2 col-lg-10 offset-lg-1 col-md-10 offset-md-1 col-sm-12 col-xs-12">
            <article>
                <header>
                    <h1>Comment déployer un serveur de développement Vault vers Kubernetes avec Helm.</h1>
                    <div> March 17, 2018 / Adrian Todorov </div>
                </header>
                <p><img src="/images/blog/post/Vault2.png" class="main-blog-image"></p>

<p><h2>La première étape vers le stockage, l’accès et le déploiement sécuritaire, dans le nuage ou sur place, d’informations sensibles relatives aux applications.</h2><p>Dans le monde d’aujourd’hui, qui est orienté API et plateforme infonuagique, nous, opérateurs, développeurs et architectes, sommes placés devant le défi de taille que représentent la gestion des secrets d’application, le cryptage et l’accès à toute application ou infrastructure infonuagique. Sécuriser et faire la rotation de secrets régulièrement et correctement, tant dans le nuage que sur place, représente tout un défi. Il est pourtant essentiel de le faire pour que votre équipe DevOps puisse adopter l’Infrastructure en tant que Code.</p><p>Les secrets sont des renseignements sensibles relatifs à la configuration d’une application. Ils incluent des éléments tels que les clés API d’AWS, les mots de passe de bases de données, et les clés privées SSL et SSH. Contrairement aux secrets statiques qui sont définis à l’avance et sont partagés, les secrets dynamiques sont générés sur demande et sont uniques à chaque client. Comme ils n’existent pas tant qu’ils ne sont pas lus, les secrets dynamiques ne courent pas le risque d’être volés et sont plus en sécurité. Vault associe chaque secret dynamique à un bail et détruit automatiquement les identifiants du secret lorsque le bail expire. HashiCorp Vault donne aux développeurs et aux opérateurs la responsabilité de stocker, d’accéder et de déployer l’information délicate de façon sécuritaire, vers les applications et les infrastructures, en utilisant un flux de travail central qui garde en sécurité, par le cryptage des données en mouvement et au repos, les secrets et les données d’application. Cela élimine l’étalement des secrets et permet la rotation, la révocation d’accès et la portabilité des secrets.</p><p><strong>L’étalement des secrets</strong> – HashiCorp Vault place tous vos secrets en un seul endroit. Dorénavant, plus besoin de coder les identifiants en dur dans le code source. La plupart du temps, ces identifiants codés en dur finissent éparpillés parmi les fichiers de configuration et les outils de gestion de configuration et stockés en texte clair en contrôle de version, wikis ou volumes partagés. Vault fournit un endroit sécuritaire pour stocker ces identifiants et assurer qu’ils soient cryptés et que leur accès soit enregistré par audit et donné uniquement aux clients autorisés. Cela élimine l’étalement des secrets et facilite l’identification de fuites potentielles dans votre infrastructure.</p><p><strong>Rotation des secrets</strong> – Avec Vault, vous ne verrez plus comme statique l’information sensible dans votre environnement multinuages. La création, la rotation et le cryptage de secrets sont automatisés dans votre pipeline CI/CD. Comme les secrets sont fréquemment en rotation, un pirate qui une semaine, obtiendrait l’accès à vos secrets, le perdrait la semaine suivante.</p><p>Vault associe chaque secret dynamique à un bail. Lorsque le bail expire, les identifiants du secret sont automatiquement détruits. Comme ils n’existent pas tant qu’ils ne sont pas lus, les secrets dynamiques ne courent pas le risque d’être volés. Tout secret généré de façon dynamique est associé à un bail et Vault révoquera automatiquement ces secrets, une fois le bail expiré.</p><p><strong>Révocation d’accès</strong> – Les politiques de contrôle d’accès fournissent un contrôle strict de l’accès aux secrets. Vault inclut des mécanismes de révocation dans leurs secrets dynamiques. Ils peuvent donc être révoqués immédiatement après l’usage ce qui minimise le temps d’existence des secrets. Vault garde les secrets dynamiques plus en sécurité et leur permet d’être déployés sur de multiples environnements infonuagiques.</p><p><strong>Déploiements portatifs</strong> – Le déploiement de secrets dynamiques se fait traditionnellement par un fournisseur infonuagique à grande échelle. Vault permet le transport des secrets entre les nuages privés ou publics, ainsi que leur soutien sur toutes sortes de serveurs et de bases de données. Voici quelques exemples de moteurs de secrets soutenus par Vault :<br> Bases de données (PostgreSQL, MySQL, MSSQL, Oracle, etc.)<br> NoSQL (Cassandra, MongoDB, etc.)<br> File d’attente des messages (RabbitMQ, etc.)<br> Fournisseurs infonuagiques<br> SSH<br> PKI</p><p>Vault vous donne accès au meilleur des deux mondes et vous permet de transporter vos secrets dynamiques vers de multiples environnements en stockant vos secrets dans un système HashiCorp qui soutient les déploiements multinuages.</p><p>Dans cet article, nous allons créer dynamiquement des clés d’identité et de gestion d’accès AWS (AWS Identity and Access Management IAM) avec un serveur de développement Vault déployé dans Kubernetes avec Helm.</p><h2>Cas d’utilisation pour la série : Un ex-employé, un pirate ou un voleur avec un accès API obtient des secrets par une application ayant des identifiants API</h2><p>De nombreuses entreprises stockent leurs secrets sur des variables d’environnement ou sur un fichier config (comment l’API ou le CLI d’AWS fonctionnent du premier coup), ou les codent en dur directement dans le code source de contrôle de version. Ne faites pas ça. Vault offre une meilleure solution.</p><p>Imaginons qu’un employé ayant des privilèges d’utilisateurs avancés, ou similaires, chez un fournisseur de services infonuagiques est congédié ou se fait voler son ordinateur portable dans un café. Le voleur ou l’ex-employé pourrait obtenir l’accès aux données sensibles en utilisant les clés API utilisées auparavant comme variables environnementales pour connecter les différentes API infonuagiques. Il pourrait ensuite supprimer des données et des sauvegardes, mettre fin à des serveurs et causer des dommages importants à l’infrastructure infonuagique de l’organisation.</p><p>Ça n’a rien à voir avec Console ou avec un accès API qui est lié à un fournisseur d’identité, comme Active Directory. Maintenant que vous devez désactiver manuellement et faire la rotation des clés API individuelles, les temps d’arrêt qui en découlent causeront des maux de tête à l’équipe des opérations.</p><p>HashiCorp, non seulement résout ce problème, il vous permet aussi de révoquer (par une seule commande) les clés API (particulièrement celles pouvant être accédées par un ex-employé ou un employé dont l’ordinateur portable a été volé) et en générer de nouvelles pour l’utilisation de l’application. Essentiellement, l’application fera automatiquement la requête d’une nouvelle clé API générée par l’interface API bien documentée de HashiCorp Vault.</p><p>Le pouvoir de révoquer et de renouveler automatiquement l’accès aux secrets est une fonctionnalité importante. De plus, chacune de ces requêtes est enregistrée et peut être vérifiée et archivée pour des raisons de conformité. D’autres techniques de stockage de secrets n’offrent pas ce type de capacité d’enregistrement et de vérification, surtout lors de requêtes individuelles d’API, d’une clé API ou d’accès à un service qui utilise une clé API.</p><p>Vault élimine l’étalement des secrets et gère leur cycle de vie en révoquant et en effectuant automatiquement un roulement des clés API ou des mots de passe de base de données. Il fournit, à l’équipe ou à l’organisation qui a accès à la création de secrets, à la lecture des secrets et au renouvellement ou à la révocation des secrets d’application, des enregistrements d’audits détaillés avec contrôle d’accès granulaire.</p><p><img class="alignright" style="width: 50%;" src="/images/blog/post/Hacker-5-5.png " alt="Hacker"></p><p><strong>Tutoriel — comment déployer un serveur de développement Vault sur Kubernetes avec Helm.</strong></p><p>Dans ce tutoriel, nous allons déployer un serveur de développement Vault sur Kubernetes avec Helm et avec l’incubateur Helm Chart. Le serveur dev stocke toutes ses données en mémoire (mais quand même cryptées) et lorsque la requête est faite, il descelle et présente automatiquement la clé Vault pour desceller et la clé d’accès root. Vous ne devriez jamais exploiter un serveur dev mode en production.</p><p><strong>Qu’est-ce que Helm et Helm charts ?</strong></p><p>Helm aide à gérer les applications Kubernetes. Helm Charts aide à définir, installer et mettre à niveau les applications Kubernetes les plus complexes. C’est un paquet qui contient toutes les définitions de ressources nécessaires à l’exécution d’une application, d’un outil ou d’un service dans une grappe Kubernetes. Considérez-le comme l’équivalent Kubernetes d’une formule homebrew, d’un Apt dpkg ou d’un fichier Yum RPM. Nous allons utiliser le diagramme (chart) incubateur « Vault » de Kubernetes.</p><p><strong>Ce qu’il vous faut</strong></p><p><a href="https://github.com/kubernetes/helm#install">https://github.com/kubernetes/helm#install</a>.<br> Avant de commencer ce tutoriel, assurez-vous d’utiliser une grappe Kubernetes de version 1.6 ou supérieure. Assurez-vous que <a href="https://github.com/kubernetes/helm#install" target="_blank">Helm</a> soit installé sur votre machine client et que kubectl est installé et configuré pour se connecter à votre grappe Kubernetes. Si vous avez plus d’une grappe, utilisez la grappe de développement pour ce tutoriel.</p><h2>Déployer Vault sur Kubernetes avec Helm</h2><p>Une fois que Helm est prêt, initialisez le CLI local et installez Tiller dans votre grappe Kubernetes en une étape :</p><pre>$ helm init</pre><p>Si vous tapez :</p><pre> $ helm version</pre><p>Vous devriez voir :</p><pre>Client: &amp;version.Version{SemVer:&ldquo;v2.8.1&rdquo;,
GitCommit:&ldquo;6af75a8fd72e2aa18a2b278cfe5c7a1c5feca7f2&rdquo;,
GitTreeState:&ldquo;clean&rdquo;}
Server: &amp;version.Version{SemVer:&ldquo;v2.8.1&rdquo;,
GitCommit:&ldquo;6af75a8fd72e2aa18a2b278cfe5c7a1c5feca7f2&rdquo;,
GitTreeState:&ldquo;clean&rdquo;}</pre><p>Cela signifie que Helm et ses composants du côté serveur (Tiller) sont installés et prêts à être utilisés. Ajoutons maintenant le dépôt incubateur à Helm.</p><pre>$ helm repo add incubator <a href="http://storage.googleapis.com/kubernetes-charts-incubator">http://storage.googleapis.com/kubernetes-charts-incubator</a></pre><p>Actuellement, votre Chart utilise l’image docker Vault de Docker Hub avec une version vault 0.9.0.</p><pre>image:
  repository: vault
  tag: 0.9.0
  pullPolicy: IfNotPresent</pre><p>Afin de déployer une version de développement de Vault running, exécuter la commande suivante :</p><pre>$ helm install incubator/vault &ndash;name vault-dev</pre><p>Cela provisionnera automatiquement un service, un déploiement, un pod et une ConfigMap Kubernetes comme ci-dessous :</p><pre>NAME:   vault-dev
LAST DEPLOYED: Wed Mar 14 17:13:43 2018
NAMESPACE: default
STATUS: DEPLOYED</p>

<p>RESOURCES:
==&gt; v1/ConfigMap
NAME                      DATA  AGE
vault-dev-vault-config-1  1     0s</p>

<p>==&gt; v1/Service
NAME             TYPE       CLUSTER-IP     EXTERNAL-IP  PORT(S)   AGE
vault-dev-vault  ClusterIP  100.68.247.74         8200/TCP  0s</p>

<p>==&gt; v1beta1/Deployment
NAME             DESIRED  CURRENT  UP-TO-DATE  AVAILABLE  AGE
vault-dev-vault  1        0        0           0          0s</p>

<p>==&gt; v1/Pod(related)
NAME                              READY  STATUS             RESTARTS  AGE
vault-dev-vault-764c78cd94-xqxfn  0/1    ContainerCreating  0         0s</pre><p>Helm fournit un ensemble de notes que vous pouvez utiliser pour vous connecter au serveur Vault avec les capacités de redirection de port de kubectl.</p><pre>NOTES:
1. Get the application URL by running these commands:
export POD_NAME=$(kubectl get pods &ndash;namespace default -l &ldquo;app=vault&rdquo; -o jsonpath=&ldquo;{.items[0].metadata.name}&ldquo;)
  echo &ldquo;Use <a href="http://127.0.0.1:8200">http://127.0.0.1:8200</a> as the Vault address after forwarding.&rdquo;
  kubectl port-forward $POD_NAME 8200:8200</pre><p>À l’instant, le serveur Vault est exposé à la grappe Kubernetes à l’interne seulement. Seuls les services Kubernetes peuvent communiquer entre eux, et non les utilisateurs externes. Vous devriez pouvoir vous connecter au serveur Vault à partir de n’importe quelle application en utilisant le service déployé par Helm.</p><pre><a href="http://vault-dev-vault:8200">http://vault-dev-vault:8200</a></pre><p>Il existe une façon de l’exposer, en dehors de la grappe, par un contrôleur et des ressources Ingress. Cela dépasse le cadre de cet article de blogue. Dans le cas qui nous intéresse, nous allons exécuter la première commande « exporter » dans la section NOTES afin d’obtenir le nom du pod qui a été déployé.</p><pre>$ export POD_NAME=$(kubectl get pods &ndash;namespace default -l &ldquo;app=vault&rdquo; -o jsonpath=&ldquo;{.items[0].metadata.name}&ldquo;)</pre><p>Pour voir le Root Token important et nécessaire pour procéder à la génération de secrets dynamiques AWS qui fait partie du présent article de blogue, exécutez :</p><pre>$ kubectl logs $POD_NAME</pre><p>Vous devriez voir apparaitre ceci sur votre terminal :</p><p><img style="width: 100%;" src="/images/blog/post/adrian1.png " alt="Terminal"></p><p>Le Root Token est surligné ici. Veuillez le noter quelque part puisque vous en aurez besoin plus tard.</p><p>Ensuite, redirigez le port au pod exploité sur notre grappe Kubernetes en exécutant la dernière commande NOTES ci-dessous :</p><pre>$ kubectl port-forward $POD_NAME 8200:8200</pre><p><img style="width: 100%;" src="/images/blog/post/Adrian2.png " alt="Terminal"></p><p>Cela permettra à votre adresse IP locale (127.0.0.1:8200) d’agir comme mandataire pour le serveur Vault.</p><p>Ensuite, ouvrez un nouvel onglet ou une nouvelle fenêtre terminal. Après avoir ouvert le nouveau terminal, tapez ceci pour exporter la variable environnementale :</p><pre>$ export VAULT_ADDR=&lsquo;<a href="http://127.0.0.1:8200'">http://127.0.0.1:8200'</a></pre><p>Nous avons maintenant besoin de télécharger le <a href="https://www.vaultproject.io/downloads.html" target="_blank">système binaire Vault</a> sur notre machine de client afin de communiquer et d’exécuter les commandes Vault CLI. Vault est une multiplateforme alors elle devrait fonctionner sur n’importe quelle plateforme.</p><p>Vous devriez être capable de mettre en vault l’exécutable Unix pour Linux/Mac. Ouvrez votre terminal et changez votre répertoire vers le chemin où est stocké et typé l’exécutable vault.</p><pre>$ vault status</pre><p><img style="width: 100%;" src="/images/blog/post/Adrian3.png " alt="Terminal"></p><p>Ensuite, connectez-vous au serveur vault en collant le Root token obtenu de la section logs :</p><pre>$ vault login</pre><p><img style="width: 100%;" src="/images/blog/post/Adrian4.png " alt="Terminal"></p><p>On peut maintenant se féliciter. Nous avons réussi à déployer un serveur de développement Vault sur Kubernetes avec Helm.</p><p>Pour activer les secrets dynamiques d’AWS sur Vault, tapez la commande suivante dans votre terminal :</p><pre>$ vault secrets enable -path=aws aws</pre><p><img style="width: 100%;" src="/images/blog/post/1.png" alt="Terminal"></p><p>Avant de procéder, configurons d’abord notre compte AWS pour qu’il utilise les secrets.</p><p>Allez à <a href="https://console.aws.amazon.com/iam/home?region=us-east-1#/users" target="_blank">IAM Management Console</a> et créez un nouvel Utilisateur avec les permissions suivantes : ne lui donnez que l’accès : Programmatic Access.</p><p><img style="width: 100%;" src="/images/blog/post/2.png" alt="Terminal"></p><p>Créez une politique et joignez-la à l’utilisateur. Nommez-la “ hashicorp-vault-lab ”. Assurez-vous de remplacer votre ID de compte dans &nbsp;» Resource «&nbsp;. Ainsi, quand Vault crée dynamiquement les utilisateurs, le nom d’utilisateur commence par le préfixe &nbsp;» vault- «&nbsp;.</p><p>On trouve le numéro de compte dans <a href="https://console.aws.amazon.com/support/home?region=us-east-1#" target="_blank">AWS Support Dashboard</a>:</p><pre>{
    &ldquo;Version&rdquo;: &ldquo;2012-10-17&rdquo;,
    &ldquo;Statement&rdquo;: [
        {
            &ldquo;Effect&rdquo;: &ldquo;Allow&rdquo;,
            &ldquo;Action&rdquo;: [
                &ldquo;iam:AttachUserPolicy&rdquo;,
                &ldquo;iam:CreateAccessKey&rdquo;,
                &ldquo;iam:CreateUser&rdquo;,
                &ldquo;iam:DeleteAccessKey&rdquo;,
                &ldquo;iam:DeleteUser&rdquo;,
                &ldquo;iam:DeleteUserPolicy&rdquo;,
                &ldquo;iam:DetachUserPolicy&rdquo;,
                &ldquo;iam:ListAccessKeys&rdquo;,
                &ldquo;iam:ListAttachedUserPolicies&rdquo;,
                &ldquo;iam:ListGroupsForUser&rdquo;,
                &ldquo;iam:ListUserPolicies&rdquo;,
                &ldquo;iam:PutUserPolicy&rdquo;,
                &ldquo;iam:RemoveUserFromGroup&rdquo;
            ],
            &ldquo;Resource&rdquo;: [
                &ldquo;arn:aws:iam::ACCOUNT_ID:user/vault-*&rdquo;
            ]
        }
    ]
}</pre><p>Vous devriez avoir un utilisateur avec la politique jointe comme ceci :</p><p><img style="width: 100%;" src="h/images/blog/post/5.png" alt="Terminal"></p><p>Vous devriez aussi recevoir un fichier .csv avec les clés “Access Key ID” et “Secret Access Key.” Seules ces clés devraient être utilisées pour configurer Vault. Pour des raisons de sécurité, supprimez-les de votre ordinateur immédiatement après, car Vault gère le cryptage de ces clés de façon interne. Elles ne peuvent être lues après avoir été configurées, on ne peut que les écraser.<br> Voici un exemple de ce qu’il faut faire pour les configurer : veuillez remplacer “ access_key ” et “ secret_key ” par vos clés.</p><pre>$ vault write aws/config/root <br />
    access_key=ACCESS_KEY_ID <br />
    secret_key=SECRET_ACCESS_KEY
</pre><p><img style="width: 100%;" src="/images/blog/post/6.png" alt="Terminal"></p><p>Ensuite, créez un rôle à utiliser avec Vault pour que, au besoin, votre application ait un utilisateur associé à ce rôle. Par exemple, votre application pourrait nécessiter un rôle qui peut faire n’importe quelle opération CRUD sur S3. Créons-en un maintenant. Vous pouvez le restreindre autant que vous le désirez. Joignez une politique à ce rôle en utilisant un relevé direct EOF (End-Of-File).</p><p><img style="width: 100%;" src="/images/blog/post/weird.png" alt="Terminal"></p><p><img style="width: 100%;" src="/images/blog/post/7.png" alt="Terminal"></p><p>Si votre application infonuagique sur place ou <a href="https://www.cloudops.com/fr/2018/02/informatique-sans-serveur-on-aime-ou-pas%E2%80%89-2/" target="_blank">sans serveur</a> a besoin d’obtenir un accès S3 et d’utiliser une clé &nbsp;» API access key «&nbsp;, vous pouvez simplement utiliser un &nbsp;» Vault token &nbsp;» pour vous connecter par l’interface Vault RESTful API. Dans ce cas-ci, votre Vault token devrait être autre chose que vos identifiants root en production, vous les créez spécialement pour permettre à votre application de créer des clés d’accès et d’être incapable de lire toutes les autres clés d’accès. Vous trouverez de plus amples informations sur RESTful API <a href="https://www.vaultproject.io/api/secret/aws/index.html" target="_blank">ici</a>. Le point particulier relatif à l’utilisation dans votre application se trouve <a href="https://www.vaultproject.io/api/secret/aws/index.html#generate-iam-credentials" target="_blank">ici</a>.</p><p>Dans le cadre de ce tutoriel, nous allons le réaliser en utilisant à la place, l’outil CLI Vault pour générer un utilisateur IAM temporaire avec Vault :</p><pre>$ vault read aws/creds/s3-all-crud-role</pre><p><img style="width: 100%;" src="/images/blog/post/8.png" alt="Terminal"></p><p>Vous pouvez aussi l’exporter en format JSON. Par défaut, il est en format table, donc vous pouvez l’éditer avec jq en utilisant le paramètre -format=json.</p><pre>$ vault read -format=json aws/creds/s3-all-crud-role</pre><p><img style="width: 100%;" src="/images/blog/post/9.png" alt="Terminal"></p><p>Comme vous pouvez le constater, il a généré 2 identifiants complètement différents ; les deux identifiants ont une durée de bail de 768 heures. Cela signifie que Vault supprimera automatiquement les utilisateurs dans AWS après 768 heures.</p><p>Si vous allez à AWS IAM et recherchez “vault-”, vous devriez pouvoir les trouver.</p><p><img style="width: 100%;" src="/images/blog/post/10.png" alt="Terminal"></p><p>La génération de secrets dynamiques de Vault est pratique, car elle a pris le rôle, a généré l’utilisateur, joint la politique et vous a redonné la clé d’accès et la clé de secret :</p><p><img style="width: 100%;" src="/images/blog/post/12.png" alt="Terminal"></p><p>Il serait peut-être bon d’augmenter la sécurité en configurant un bail de 24 heures en ajoutant à la configuration une valeur-clé dans Vault comme ceci :</p><pre>$ vault write aws/config/lease lease=24h lease_max=24h</pre><p>Les clés générées avec les nouveaux utilisateurs IAM un une durée de bail de 24 heures :</p><p><img style="width: 100%;" src="/images/blog/post/13.png" alt="Terminal"></p><p>Après 24 heures, Vault supprimera automatiquement l’utilisateur.</p><p>Idéalement, vous devriez utiliser l’ID de bail &nbsp;» lease_id &nbsp;» afin de renouveler l’utilisateur, ainsi, l’application n’est pas constamment en train de créer de nouveaux utilisateurs IAM. Pour ce faire, utiliser L’ID de bail &nbsp;» lease_id &nbsp;» fourni par Vault afin de renouveler simplement le bail.</p><p>Vous pouvez aussi utiliser le RESTful API de Vault <a href="https://www.vaultproject.io/api/system/leases.html" target="_blank">ici</a> :</p><p>Renouvelons la licence pour une heure seulement en utilisant le &nbsp;» lease_id &nbsp;» et 3600 secondes :</p><pre>$ vault lease renew aws/creds/s3-all-crud-role/e928e56d-0261-5e03-d0ee-bce23c3005a4 3600</pre><p><img style="width: 100%;" src="/images/blog/post/14.png" alt="Terminal"></p><p><strong>Houston, nous avons un problème. Nous avons été piratés.</strong></p><p>Supposons que vous utilisez vos outils de surveillance pour attraper quelqu’un essayant d’obtenir l’accès à l’une de vos applications. Toutefois, ils ont pu copier une de vos variables environnementales contenant les clés : AWS API Key et Secret Access Keys générées avec Vault par votre application.</p><p>Comment pouvons-nous arrêter le pirate avant qu’il ne cause de sérieux dommages à votre organisation ?</p><p>Vous n’avez simplement qu’à révoquer les baux qui ont ces identifiants en utilisant, soit la CLI ou la RESTful API :</p><pre>$ vault lease revoke -prefix aws/creds/s3-all-crud-role</pre><p><img style="width: 100%;" src="/images/blog/post/5-1.png" alt="Terminal"></p><p>Comme vous pouvez le constater, Vault a pu utiliser : &nbsp;» -prefix of s3-all-crud-role &nbsp;» pour révoquer tous les baux associés à ces rôles.</p><p><img style="width: 100%;" src="/images/blog/post/15.png" alt="Terminal"></p><p>Vault est un outil fantastique qui simplifiera la sécurité de votre infrastructure. Cela éliminera l’étalement des secrets et facilitera la découverte de vulnérabilités. Il fera automatiquement la rotation des secrets et révoquera l’accès non autorisé. Les secrets dynamiques sont bien, en tant que tels, mais avec HashiCorps, ils deviennent fantastiques.</p><p>Jetez un œil sur mon <a href="https://github.com/adriantodorov/cloudops-vault-part-1" target="_blank">repos</a> pour plus d’idées de façons d’ajouter de la sécurité à votre Infrastructure en tant que Code.</p><p>Pour en apprendre plus sur l’utilisation de Docker et Kubernetes dans AWS, inscrivez-vous à l’un de nos <https: www.cloudops.com="" fr="" ateliers-docker-kubernetes="" "="" target="_blank">ateliers. Nous offrons une gamme d’ateliers pratiques de trois jours pour vous aider à adopter les pratiques DevOps.</https:></p><p>&nbsp;</p><h3><img class="size-full wp-image-749 alignleft" title="Adrian Todorov" src="/images/blog/post/Adrian.png" alt="" style="width: 150px;" width="150" height="150">À propos de l’auteur – Adrian Todorov</h3><p> Adrian Todorov est architecte de solutions de conteneur chez CloudOps. Il travaille de près avec Kubernetes, AWS, GCP et HashiCorp pour faire avancer la modernisation d’applications. Ce qu’Adrian aime par-dessus tout, c’est d’amener les clients vers les technologies et les processus de développement infonuagiques modernes, il espère guider les lecteurs à travers l’utilisation des projets de source libre dans leur application.</p></p>

            </article>
        </div>
    </div>


    <div class="row nav-buttons back-foward in-content">
        <div class="col-xl-4 offset-xl-2 col-lg-5 offset-lg-1 col-md-5 offset-md-1 col-sm-5 offset-sm-1 col-xs-2 back-button">
            <a href="/fr/blog/comment-deployer-consul-dans-gcp-en-utilisant-terraform-les-premieres-etapes-vers-lautomatisation-devops/"><button class="btn">
                    <div class="triangle-left">
                        <div class="inner-left-triangle"></div>
                    </div>Previous Post
                </button></a>
        </div>
        <div class="col-xl-4 col-lg-5 col-md-5 col-sm-5 col-xs-2 foward-button">
            <a href="/fr/blog/conteneuriser-une-paro-plateforme-dautomatisation-de-reseau-ouverte-par-souci-defficacite-les-raisons-pour-lesquelles-bell-a-cree-la-gop-avec-kubernetes/">
                <button class="btn">
                    Next Post<div class="triangle-right">
                        <div class="inner-triangle"></div>
                    </div>
                </button></a>
        </div>
    </div>

    <div class="social">
        

<style>
#share-buttons {display: inline-block; vertical-align: middle; }
#share-buttons:after {content: ""; display: block; clear: both;}
#share-buttons > div {
position: relative;
text-align: left; 
height: 36px; 
float: left; 
text-align: center;
}
#share-buttons > div > svg {height: 36px; fill: #005D91; margin-top: 0;}
#share-buttons > div:hover {cursor: pointer;}
#share-buttons > div.facebook:hover > svg {fill: #3B5998;}
#share-buttons > div.twitter:hover > svg {fill: #55ACEE;}
#share-buttons > div.linkedin:hover > svg {fill: #0077b5;}
#share-buttons > div.mail:hover > svg {fill: #7D7D7D;}
#share-buttons > div.facebook > svg {height: 30px; margin: auto 5px;}
#share-buttons > div.twitter > svg {height: 30px; margin: auto 5px;}
#share-buttons > div.linkedin > svg {height: 30px; margin: auto 5px;}
#share-buttons > div.mail > svg {height: 30px; margin: auto 5px;}
</style>

<div id="share-buttons">
<div class="facebook" title="Share this on Facebook" onclick="window.open('http://www.facebook.com/share.php?u=\/fr\/blog\/comment-deployer-un-serveur-de-developpement-vault-vers-kubernetes-avec-helm\/');"><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1343 12v264h-157q-86 0-116 36t-30 108v189h293l-39 296h-254v759h-306v-759h-255v-296h255v-218q0-186 104-288.5t277-102.5q147 0 228 12z"/></svg></div>
<div class="twitter" title="Share this on Twitter" onclick="window.open('http://twitter.com/home?status=\/fr\/blog\/comment-deployer-un-serveur-de-developpement-vault-vers-kubernetes-avec-helm\/');"><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1684 408q-67 98-162 167 1 14 1 42 0 130-38 259.5t-115.5 248.5-184.5 210.5-258 146-323 54.5q-271 0-496-145 35 4 78 4 225 0 401-138-105-2-188-64.5t-114-159.5q33 5 61 5 43 0 85-11-112-23-185.5-111.5t-73.5-205.5v-4q68 38 146 41-66-44-105-115t-39-154q0-88 44-163 121 149 294.5 238.5t371.5 99.5q-8-38-8-74 0-134 94.5-228.5t228.5-94.5q140 0 236 102 109-21 205-78-37 115-142 178 93-10 186-50z"/></svg></div>
<div class="linkedin" title="Share this on Linkedin" onclick="window.open('https://www.linkedin.com/shareArticle?mini=true&url=\/fr\/blog\/comment-deployer-un-serveur-de-developpement-vault-vers-kubernetes-avec-helm\/&title=&summary=&source=');"><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M477 625v991h-330v-991h330zm21-306q1 73-50.5 122t-135.5 49h-2q-82 0-132-49t-50-122q0-74 51.5-122.5t134.5-48.5 133 48.5 51 122.5zm1166 729v568h-329v-530q0-105-40.5-164.5t-126.5-59.5q-63 0-105.5 34.5t-63.5 85.5q-11 30-11 81v553h-329q2-399 2-647t-1-296l-1-48h329v144h-2q20-32 41-56t56.5-52 87-43.5 114.5-15.5q171 0 275 113.5t104 332.5z"/></svg></div>
<div class="mail" title="Share this through Email" onclick="window.open('mailto:?&body=\/fr\/blog\/comment-deployer-un-serveur-de-developpement-vault-vers-kubernetes-avec-helm\/');"><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1792 710v794q0 66-47 113t-113 47h-1472q-66 0-113-47t-47-113v-794q44 49 101 87 362 246 497 345 57 42 92.5 65.5t94.5 48 110 24.5h2q51 0 110-24.5t94.5-48 92.5-65.5q170-123 498-345 57-39 100-87zm0-294q0 79-49 151t-122 123q-376 261-468 325-10 7-42.5 30.5t-54 38-52 32.5-57.5 27-50 9h-2q-23 0-50-9t-57.5-27-52-32.5-54-38-42.5-30.5q-91-64-262-182.5t-205-142.5q-62-42-117-115.5t-55-136.5q0-78 41.5-130t118.5-52h1472q65 0 112.5 47t47.5 113z"/></svg></div>
</div>

        <i class="far fa-copy copy-page-link"></i>
    </div>


    </div>
</main>

        </div><div class="footer">
    <div class="row logo">
        <div class="col-sm-12">
            <a href="/"><img class="cloudops-logo" src="/images/cO-logo-horizontal.png"
                    height="45px" width="auto"></a>
        </div>
    </div>

    <div class="row footer-content">
        <div class="col-xl-3 offset-xl-2 col-lg-3 offset-lg-0 col-md-12">

            <i class="fab fa-twitter"></i>
            <i class="fab fa-linkedin-in"></i>
            <i class="fab fa-facebook-f"></i>
            <h5>Newsletter Signup</h5>
            <div class="newsletter-form">
                    <div class="newsletter-form">

<script charset="utf-8" type="text/javascript" src="//js.hsforms.net/forms/v2.js"></script>
<script>
  hbspt.forms.create({
	portalId: "732832",
	formId: "25575fb9-f01b-43a6-b9cd-2c154efad9f4"
});
</script>
                </div>
            </div>
        </div>
        <div class="col-xl-2 col-lg-3 col-md-12 col-sm-12 footer-nav">
            <h6>Services</h6>
            <ul>
                <li><a href="/cloud-native-consulting">Cloud Native Consulting</a></li>
                <li><a href="/transformations">Transformations</a></li>
                <li><a href="/managed-services-augmented-support">Support</a></li>
                <li><a href="/delivering-cloud">Cloud Delivery</a></li>
            </ul>
        </div>

        <div class="col-xl-2 col-lg-3 col-md-12 footer-nav">
            <h6>Learning</h6>
            <ul>
                <li><a href="/workshops">Workshops</a></li>
                <li><a href="/blog">Blog</a></li>
                <li><a href="/workshops-calendar">Events</a></li>
                <li><a href="/reading/ressources/#case-studies">Case Studies</a></li>
            </ul>
        </div>

        <div class="col-xl-2 col-lg-3 col-md-12 footer-nav">
            <h6>Company</h6>
            <ul>
                <li><a href="/about-us">About Us</a></li>
                <li><a href="/careers">Careers</a></li>
                <li><a href="/partners">Partners</a></li>
                <li><a href="/why-cloudops">Why Cloudops</a></li>
            </ul>
        </div>
    </div>

    <div class="row copyright">
        <div class="col-sm-12">
            <p>&copy; CloudOps. Tous droits réservés.</p>
        </div>
    </div>
</div>
        <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
        <script src="https://unpkg.com/clipboard@2/dist/clipboard.min.js"></script>
        <script src="/js/main.js"></script>

        </body>
</html>